#!/usr/bin/env bash
# Pre-commit hook that runs linting, formatting, and tests

set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
	echo "â„¹ï¸  No staged files to check"
	exit 0
fi

# Format staged files (only TypeScript/JavaScript/JSON files)
FILE_ARRAY=()
for file in $STAGED_FILES; do
	if [ -f "$file" ] && [[ "$file" =~ \.(ts|tsx|js|jsx|json)$ ]]; then
		FILE_ARRAY+=("$file")
	fi
done

# Only format if we have files to format
if [ ${#FILE_ARRAY[@]} -gt 0 ]; then
	echo "ğŸ“ Formatting staged files..."
	bunx biome format --write "${FILE_ARRAY[@]}" || true
	# Stage formatted files (in case formatting changed them)
	git add "${FILE_ARRAY[@]}" || true
else
	echo "â„¹ï¸  No TypeScript/JavaScript files to format"
fi

# Lint staged files (only TypeScript/JavaScript/JSON files, exclude markdown)
LINT_FILES=()
for file in "${FILE_ARRAY[@]}"; do
	if [[ "$file" =~ \.(ts|tsx|js|jsx|json)$ ]]; then
		LINT_FILES+=("$file")
	fi
done

# Only lint if we have files to lint
if [ ${#LINT_FILES[@]} -gt 0 ]; then
	echo "ğŸ” Linting staged files..."
	if ! bunx biome check "${LINT_FILES[@]}"; then
		echo "âŒ Linting failed. Please fix the errors above."
		exit 1
	fi
else
	echo "â„¹ï¸  No TypeScript/JavaScript files to lint"
fi

# Run tests (skip if no tests found)
echo "ğŸ§ª Running tests..."
if bun run test 2>&1 | grep -q "No tests found"; then
	echo "â„¹ï¸  No tests found, skipping test step"
else
	if ! bun run test; then
		echo "âŒ Tests failed. Please fix the errors above."
		exit 1
	fi
fi

# Regenerate Convex types before build (needed for TypeScript compilation)
echo "ğŸ”„ Regenerating Convex types..."
if ! bun run --cwd convex codegen; then
	echo "âš ï¸  Convex codegen failed, but continuing with build..."
fi

# Run build check to catch TypeScript and build errors
echo "ğŸ”¨ Running build check..."
if ! bun run build; then
	echo "âŒ Build failed. Please fix the errors above."
	exit 1
fi

# Build shared package first (reporters depend on it)
echo "ğŸ“¦ Building shared package..."
if ! bun run build:shared; then
	echo "âŒ Shared package build failed. Please fix the errors above."
	exit 1
fi

# Run reporters build to ensure reporter packages build and emit declarations
echo "ğŸ“¦ Building reporters..."
if ! bun run build:reporters; then
	echo "âŒ Reporters build failed. Please fix the errors above."
	exit 1
fi

# Check if any Convex files changed
CONVEX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^convex/.*\.(ts|js)$' || true)

if [ -n "$CONVEX_FILES" ]; then
	echo "ğŸš€ Validating Convex deployment..."
	if ! bunx convex deploy --yes; then
		echo "âŒ Convex deployment validation failed. Please fix the errors above."
		exit 1
	fi
	
	# Stage any newly generated Convex API files
	echo "ğŸ“¦ Staging generated Convex files..."
	GENERATED_FILES=$(git diff --name-only | grep -E '^convex/_generated/.*\.(ts|js|d\.ts)$' || true)
	if [ -n "$GENERATED_FILES" ]; then
		git add $GENERATED_FILES
		echo "âœ… Staged generated files: $GENERATED_FILES"
	else
		# Also check for untracked files in case they're brand new
		UNTRACKED_FILES=$(git ls-files --others --exclude-standard | grep -E '^convex/_generated/.*\.(ts|js|d\.ts)$' || true)
		if [ -n "$UNTRACKED_FILES" ]; then
			git add $UNTRACKED_FILES
			echo "âœ… Staged new generated files: $UNTRACKED_FILES"
		fi
	fi
else
	echo "â„¹ï¸  No Convex files changed, skipping Convex validation"
fi

echo "âœ… All pre-commit checks passed!"
