#!/usr/bin/env bash
# Pre-commit hook that runs linting, formatting, and tests

set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
	echo "â„¹ï¸  No staged files to check"
	exit 0
fi

# Format staged files
echo "ğŸ“ Formatting staged files..."
FILE_ARRAY=()
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		FILE_ARRAY+=("$file")
	fi
done

if [ ${#FILE_ARRAY[@]} -gt 0 ]; then
	bunx biome format --write "${FILE_ARRAY[@]}" || true
	# Stage formatted files (in case formatting changed them)
	git add "${FILE_ARRAY[@]}" || true
fi

# Lint staged files
echo "ğŸ” Linting staged files..."
if [ ${#FILE_ARRAY[@]} -gt 0 ]; then
	if ! bunx biome check "${FILE_ARRAY[@]}"; then
		echo "âŒ Linting failed. Please fix the errors above."
		exit 1
	fi
fi

# Run tests (skip if no tests found)
echo "ğŸ§ª Running tests..."
if bun run test 2>&1 | grep -q "No tests found"; then
	echo "â„¹ï¸  No tests found, skipping test step"
else
	if ! bun run test; then
		echo "âŒ Tests failed. Please fix the errors above."
		exit 1
	fi
fi

echo "âœ… All pre-commit checks passed!"
