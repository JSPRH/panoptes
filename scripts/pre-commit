#!/usr/bin/env bash
# Pre-commit hook that runs linting, formatting, and tests

set -e

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
	echo "‚ÑπÔ∏è  No staged files to check"
	exit 0
fi

# Format staged files (only TypeScript/JavaScript/JSON files)
FILE_ARRAY=()
for file in $STAGED_FILES; do
	if [ -f "$file" ] && [[ "$file" =~ \.(ts|tsx|js|jsx|json)$ ]]; then
		FILE_ARRAY+=("$file")
	fi
done

# Only format if we have files to format
if [ ${#FILE_ARRAY[@]} -gt 0 ]; then
	echo "üìù Formatting staged files..."
	bunx biome format --write "${FILE_ARRAY[@]}" || true
	# Stage formatted files (in case formatting changed them)
	git add "${FILE_ARRAY[@]}" || true
else
	echo "‚ÑπÔ∏è  No TypeScript/JavaScript files to format"
fi

# Lint staged files (only TypeScript/JavaScript/JSON files, exclude markdown)
LINT_FILES=()
for file in "${FILE_ARRAY[@]}"; do
	if [[ "$file" =~ \.(ts|tsx|js|jsx|json)$ ]]; then
		LINT_FILES+=("$file")
	fi
done

# Only lint if we have files to lint
if [ ${#LINT_FILES[@]} -gt 0 ]; then
	echo "üîé Linting staged files..."
	if ! bunx biome check "${LINT_FILES[@]}"; then
		echo "‚ùå Linting failed. Please fix the errors above."
		exit 1
	fi
else
	echo "‚ÑπÔ∏è  No TypeScript/JavaScript files to lint"
fi

# Run tests (skip if no tests found)
# Note: React component tests require vitest/jsdom and should be run separately with 'bunx vitest run'
# Note: E2E tests require Playwright and should be run separately with 'bun run test:e2e'
echo "üß™ Running tests..."
# Clean up any leftover temp directories from previous runs
if [ -d "apps/web/src/pages/__tests__.tmp" ]; then
	rm -rf "apps/web/src/pages/__tests__.tmp"
fi
# Temporarily move React component tests to avoid bun test picking them up
REACT_TEST_DIR="apps/web/src/pages/__tests__"
TEMP_REACT_TEST_DIR="/tmp/panoptes-react-tests-$$"
if [ -d "$REACT_TEST_DIR" ]; then
	mv "$REACT_TEST_DIR" "$TEMP_REACT_TEST_DIR"
fi

# Temporarily move hook tests (require vitest/jsdom for React hooks)
HOOK_TEST_DIR="apps/web/src/hooks/__tests__"
TEMP_HOOK_TEST_DIR="/tmp/panoptes-hook-tests-$$"
if [ -d "$HOOK_TEST_DIR" ]; then
	mv "$HOOK_TEST_DIR" "$TEMP_HOOK_TEST_DIR"
fi

# Temporarily move E2E tests to avoid bun test picking them up
E2E_TEST_DIR="apps/web/e2e"
TEMP_E2E_TEST_DIR="/tmp/panoptes-e2e-tests-$$"
if [ -d "$E2E_TEST_DIR" ]; then
	mv "$E2E_TEST_DIR" "$TEMP_E2E_TEST_DIR"
fi

# Run bun test only on tests directory (exclude hook tests that require vitest/jsdom)
# Explicitly cd into tests directory to avoid bun scanning the workspace
echo "üß™ Running bun tests (tests directory only)..."
TEST_OUTPUT=$(cd tests && bun test . 2>&1)
TEST_EXIT_CODE=$?

# Restore React component tests immediately after test run
if [ -d "$TEMP_REACT_TEST_DIR" ]; then
	mv "$TEMP_REACT_TEST_DIR" "$REACT_TEST_DIR"
fi

# Restore hook tests immediately after test run
if [ -d "$TEMP_HOOK_TEST_DIR" ]; then
	mv "$TEMP_HOOK_TEST_DIR" "$HOOK_TEST_DIR"
fi

# Restore E2E tests immediately after test run
if [ -d "$TEMP_E2E_TEST_DIR" ]; then
	mv "$TEMP_E2E_TEST_DIR" "$E2E_TEST_DIR"
fi

# Check bun test results
BUN_TEST_RESULT=0
if echo "$TEST_OUTPUT" | grep -q "No tests found"; then
	echo "‚ÑπÔ∏è  No bun tests found, skipping bun test step"
	BUN_TEST_RESULT=0
else
	# Print the test output
	echo "$TEST_OUTPUT"
	# Check the exit code
	if [ $TEST_EXIT_CODE -eq 0 ]; then
		BUN_TEST_RESULT=0
	else
		BUN_TEST_RESULT=1
	fi
fi

# Run vitest for hook tests and React component tests (require jsdom)
echo "üß™ Running vitest (hook tests and React components)..."
VITEST_OUTPUT=$(bunx vitest run --reporter=verbose 2>&1)
VITEST_EXIT_CODE=$?

VITEST_RESULT=0
if echo "$VITEST_OUTPUT" | grep -q "No test files found"; then
	echo "‚ÑπÔ∏è  No vitest tests found, skipping vitest step"
	VITEST_RESULT=0
else
	# Print the test output
	echo "$VITEST_OUTPUT"
	# Check the exit code
	if [ $VITEST_EXIT_CODE -eq 0 ]; then
		VITEST_RESULT=0
	else
		VITEST_RESULT=1
	fi
fi

# Check if either test suite failed
if [ $BUN_TEST_RESULT -ne 0 ] || [ $VITEST_RESULT -ne 0 ]; then
	echo "‚ùå Tests failed. Please fix the errors above."
	exit 1
fi

# Check if any Convex files changed (before codegen)
CONVEX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^convex/.*\.(ts|js)$' || true)

# Regenerate Convex types before build (needed for TypeScript compilation)
echo "üîÑ Regenerating Convex types..."
CODEGEN_FAILED=0
if ! bun run --cwd convex codegen; then
	echo "‚ö†Ô∏è  Convex codegen failed, but continuing with build..."
	CODEGEN_FAILED=1
fi

# Run build check to catch TypeScript and build errors
# Skip build check if codegen failed and Convex files were changed
# Types will be generated when Convex is deployed
if [ $CODEGEN_FAILED -eq 1 ] && [ -n "$CONVEX_FILES" ]; then
	echo "‚ö†Ô∏è  Skipping build check - codegen failed and Convex files were changed."
	echo "‚ö†Ô∏è  Types will be generated when Convex is deployed."
else
	echo "üî® Running build check..."
	if ! bun run build; then
		echo "‚ùå Build failed. Please fix the errors above."
		exit 1
	fi
fi

# Build shared package first (reporters depend on it)
echo "üì¶ Building shared package..."
if ! bun run build:shared; then
	echo "‚ùå Shared package build failed. Please fix the errors above."
	exit 1
fi

# Run reporters build to ensure reporter packages build and emit declarations
echo "üì¶ Building reporters..."
if ! bun run build:reporters; then
	echo "‚ùå Reporters build failed. Please fix the errors above."
	exit 1
fi

# Check if any Convex files changed
CONVEX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^convex/.*\.(ts|js)$' || true)

if [ -n "$CONVEX_FILES" ]; then
	echo "üöÄ Validating Convex deployment..."
	if ! bunx convex deploy --yes; then
		echo "‚ùå Convex deployment validation failed. Please fix the errors above."
		exit 1
	fi
	
	# Stage any newly generated Convex API files
	echo "üì¶ Staging generated Convex files..."
	GENERATED_FILES=$(git diff --name-only | grep -E '^convex/_generated/.*\.(ts|js|d\.ts)$' || true)
	if [ -n "$GENERATED_FILES" ]; then
		git add $GENERATED_FILES
		echo "‚úÖ Staged generated files: $GENERATED_FILES"
	else
		# Also check for untracked files in case they're brand new
		UNTRACKED_FILES=$(git ls-files --others --exclude-standard | grep -E '^convex/_generated/.*\.(ts|js|d\.ts)$' || true)
		if [ -n "$UNTRACKED_FILES" ]; then
			git add $UNTRACKED_FILES
			echo "‚úÖ Staged new generated files: $UNTRACKED_FILES"
		fi
	fi
	
	# Regenerate OpenAPI spec after successful deployment
	echo "üìÑ Regenerating OpenAPI spec..."
	if bun run openapi:generate; then
		# Copy to public folder for web app
		if [ -f "convex-spec.yaml" ]; then
			cp convex-spec.yaml apps/web/public/convex-spec.yaml
			echo "‚úÖ Copied OpenAPI spec to web public folder"
		fi
		# Stage the updated spec if it changed
		if git diff --quiet convex-spec.yaml; then
			echo "‚ÑπÔ∏è  OpenAPI spec unchanged"
		else
			git add convex-spec.yaml apps/web/public/convex-spec.yaml
			echo "‚úÖ Updated and staged OpenAPI spec"
		fi
	else
		echo "‚ö†Ô∏è  OpenAPI spec generation failed, but continuing..."
	fi
else
	echo "‚ÑπÔ∏è  No Convex files changed, skipping Convex validation"
fi

echo "‚úÖ All pre-commit checks passed!"
